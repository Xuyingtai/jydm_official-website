# 网站部署指南

## 一、准备工作

### 1. 构建生产版本

首先，我们需要将开发版本构建为生产版本：

```bash
# 安装依赖（如果还没有安装）
npm install

# 构建生产版本
npm run build
```

构建完成后，会在项目根目录生成 `dist` 文件夹，这个文件夹包含了所有需要部署到服务器的文件。

### 2. 检查构建结果

构建完成后，可以本地预览生产版本：

```bash
npm run preview
```

在浏览器中访问 `http://localhost:4173` 检查网站是否正常显示。

---

## 二、域名解绑（旧网站）

### 步骤1：登录域名管理平台

1. 登录您的域名注册商管理平台（如阿里云、腾讯云、GoDaddy等）
2. 找到域名管理页面

### 步骤2：解绑DNS解析

在域名管理平台中：

1. 找到 **DNS解析** 或 **域名解析** 设置
2. 删除或暂停以下类型的解析记录：
   - **A记录**：指向旧服务器IP的A记录
   - **CNAME记录**：指向旧域名的CNAME记录
   - **AAAA记录**：IPv6记录（如果有）

### 步骤3：等待DNS生效

- DNS更改通常需要 **10分钟到48小时** 才能完全生效
- 可以使用在线工具检查DNS解析状态：
  - https://dnschecker.org/
  - https://www.whatsmydns.net/

### 步骤4：确认旧网站已无法访问

在浏览器中访问您的域名，确认旧网站已经无法访问或显示错误。

---

## 三、服务器准备

### 方案A：使用Nginx（推荐）

#### 1. 安装Nginx

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install nginx
```

**Linux (CentOS/RHEL):**
```bash
sudo yum install nginx
# 或
sudo dnf install nginx
```

#### 2. 上传网站文件

将 `dist` 文件夹中的所有文件上传到服务器：

```bash
# 使用SCP上传（在本地电脑执行）
scp -r dist/* root@您的服务器IP:/var/www/html/

# 或使用FTP工具（如FileZilla）上传
```

#### 3. 配置Nginx

创建或编辑Nginx配置文件：

```bash
sudo nano /etc/nginx/sites-available/jydm
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name www.zzjydm.com zzjydm.com;  # 替换为您的域名
    
    root /var/www/html;  # 网站文件路径
    index index.html;
    
    # 支持React Router的客户端路由
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
```

#### 4. 启用站点并重启Nginx

```bash
# 创建软链接（如果使用sites-available）
sudo ln -s /etc/nginx/sites-available/jydm /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

### 方案B：使用Apache

#### 1. 安装Apache

**Linux (Ubuntu/Debian):**
```bash
sudo apt install apache2
```

**Linux (CentOS/RHEL):**
```bash
sudo yum install httpd
```

#### 2. 上传网站文件

```bash
scp -r dist/* root@您的服务器IP:/var/www/html/
```

#### 3. 配置Apache

启用必要的模块：

```bash
sudo a2enmod rewrite
```

编辑Apache配置文件：

```bash
sudo nano /etc/apache2/sites-available/000-default.conf
```

添加以下配置：

```apache
<VirtualHost *:80>
    ServerName www.zzjydm.com
    ServerAlias zzjydm.com
    
    DocumentRoot /var/www/html
    
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 支持React Router
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
</VirtualHost>
```

#### 4. 重启Apache

```bash
sudo systemctl restart apache2
# 或
sudo systemctl restart httpd
```

---

## 四、域名重新绑定

### 步骤1：获取服务器IP地址

在服务器上执行：

```bash
curl ifconfig.me
# 或
hostname -I
```

### 步骤2：配置DNS解析

在域名管理平台添加新的DNS解析记录：

1. **A记录**（推荐）：
   - 主机记录：`@` 或留空（表示主域名）
   - 记录类型：`A`
   - 记录值：您的服务器IP地址
   - TTL：600（10分钟）或默认值

2. **A记录**（www子域名）：
   - 主机记录：`www`
   - 记录类型：`A`
   - 记录值：您的服务器IP地址
   - TTL：600

### 步骤3：等待DNS生效

- 等待10分钟到48小时
- 使用DNS检查工具确认解析已生效

### 步骤4：配置SSL证书（HTTPS，推荐）

#### 使用Let's Encrypt免费证书（Nginx）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d www.zzjydm.com -d zzjydm.com

# 自动续期（已自动配置）
```

#### 使用Let's Encrypt免费证书（Apache）

```bash
sudo apt install certbot python3-certbot-apache
sudo certbot --apache -d www.zzjydm.com -d zzjydm.com
```

---

## 五、验证部署

### 1. 检查网站访问

在浏览器中访问：
- http://www.zzjydm.com
- http://zzjydm.com
- https://www.zzjydm.com（如果配置了SSL）

### 2. 检查功能

- [ ] 首页正常显示
- [ ] 导航菜单正常工作
- [ ] 视频播放功能正常
- [ ] 图片正常加载
- [ ] 所有页面路由正常

### 3. 检查移动端

使用手机或浏览器开发者工具检查移动端显示是否正常。

---

## 六、常见问题排查

### 问题1：网站显示404错误

**原因**：React Router需要服务器配置支持客户端路由

**解决**：
- 确保Nginx配置中有 `try_files $uri $uri/ /index.html;`
- 确保Apache配置中有Rewrite规则

### 问题2：静态资源404

**原因**：文件路径不正确

**解决**：
- 检查 `dist` 文件夹是否完整上传
- 检查文件权限：`sudo chmod -R 755 /var/www/html`

### 问题3：域名无法访问

**原因**：DNS未生效或防火墙阻止

**解决**：
- 检查DNS解析是否生效
- 检查服务器防火墙是否开放80和443端口：
  ```bash
  sudo ufw allow 80
  sudo ufw allow 443
  ```

### 问题4：HTTPS证书问题

**解决**：
- 确保域名解析已生效
- 检查防火墙443端口是否开放
- 重新申请证书：`sudo certbot renew`

---

## 七、后续维护

### 更新网站内容

1. 在本地修改代码
2. 重新构建：`npm run build`
3. 上传新的 `dist` 文件夹内容到服务器
4. 重启Web服务器（通常不需要）

### 备份

定期备份服务器上的网站文件：
```bash
tar -czf backup-$(date +%Y%m%d).tar.gz /var/www/html
```

---

## 八、快速部署脚本

创建一个部署脚本 `deploy.sh`：

```bash
#!/bin/bash

# 构建项目
echo "正在构建项目..."
npm run build

# 上传到服务器（需要配置SSH密钥）
echo "正在上传文件..."
scp -r dist/* root@您的服务器IP:/var/www/html/

echo "部署完成！"
```

使用：
```bash
chmod +x deploy.sh
./deploy.sh
```

---

## 需要帮助？

如果在部署过程中遇到问题，请检查：
1. 服务器日志：`sudo tail -f /var/log/nginx/error.log`（Nginx）
2. DNS解析状态
3. 防火墙设置
4. 文件权限

祝您部署顺利！

